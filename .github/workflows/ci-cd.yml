name: CI/CD Pipeline for FastAPI Hello App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: rajdevtiwari/fastapi-hello
  TAG: ${{ github.sha }}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # Step 1: Checkout Repository
    # -----------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -----------------------------
    # Step 2: Setup Python
    # -----------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # -----------------------------
    # Step 3: Install Dependencies & Run Tests
    # -----------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest -q

    # -----------------------------
    # Step 4: Build Docker Image
    # -----------------------------
    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME:${TAG} .

    # -----------------------------
    # Step 5: Login to Docker Hub
    # -----------------------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # -----------------------------
    # Step 6: Push Docker Image
    # -----------------------------
    - name: Push Docker image
      run: |
        docker push $IMAGE_NAME:${TAG}

    # -----------------------------
    # Step 7: Setup Kubeconfig
    # -----------------------------
    - name: Set up kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_DATA }}" > ~/.kube/config
        chmod 600 ~/.kube/config

    # -----------------------------
    # Step 8: Verify Cluster Access
    # -----------------------------
    - name: Verify cluster connection
      run: |
        kubectl get nodes

    # -----------------------------
    # Step 9: Deploy to Kubernetes
    # -----------------------------
    - name: Deploy FastAPI app to K8s
      run: |
        kubectl set image deployment/fastapi-hello-deployment fastapi-hello-container=$IMAGE_NAME:${TAG} --record || \
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl rollout status deployment/fastapi-hello-deployment
