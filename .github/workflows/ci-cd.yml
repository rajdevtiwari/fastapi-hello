name: CI-CD (self-hosted)

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: self-hosted
    environment: production

    steps:
    # ------------------------------
    # 1ï¸âƒ£ Checkout code
    # ------------------------------
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v4

    # ------------------------------
    # 2ï¸âƒ£ Setup Python
    # ------------------------------
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # ------------------------------
    # 3ï¸âƒ£ Install dependencies
    # ------------------------------
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ------------------------------
    # 4ï¸âƒ£ Run tests
    # ------------------------------
    - name: ğŸ§ª Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: pytest -q

    # ------------------------------
    # 5ï¸âƒ£ Verify kubeconfig (real cluster)
    # ------------------------------
    - name: âš™ï¸ Verify kubeconfig (real cluster)
      run: |
        export KUBECONFIG=/home/ceekh/.kube/config
        echo "âœ… Using kubeconfig from $KUBECONFIG"
        if [ ! -f "$KUBECONFIG" ]; then
          echo "âŒ kubeconfig not found!"
          exit 1
        fi
        kubectl config current-context
        kubectl get nodes

    # ------------------------------
    # 6ï¸âƒ£ Build Docker image
    # ------------------------------
    - name: ğŸ³ Build Docker image locally
      run: |
        cd $GITHUB_WORKSPACE
        IMAGE_NAME="fastapi-hello"
        IMAGE_TAG=${{ github.sha }}
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
        echo "âœ… Image built: $IMAGE_NAME:$IMAGE_TAG"

    # ------------------------------
    # 7ï¸âƒ£ Deploy to Kubernetes
    # ------------------------------
    - name: ğŸš€ Deploy to Kubernetes
      run: |
        cd $GITHUB_WORKSPACE
        echo "ğŸ“‚ Current directory:"
        pwd
        echo "ğŸ“„ Files:"
        ls -R k8s/

        NAMESPACE=fastapi
        DEPLOYMENT=fastapi-deployment
        CONTAINER=fastapi
        IMAGE="fastapi-hello:${{ github.sha }}"

        echo "ğŸš€ Ensuring namespace exists..."
        kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

        echo "âš™ï¸ Deleting old deployment if selector changed..."
        kubectl -n $NAMESPACE delete deployment $DEPLOYMENT --ignore-not-found

        echo "ğŸ“¦ Applying manifests..."
        kubectl apply -f k8s/ -n $NAMESPACE

        echo "ğŸš€ Updating deployment with image: $IMAGE"
        kubectl -n $NAMESPACE set image deployment/$DEPLOYMENT $CONTAINER=$IMAGE --record || true
        kubectl -n $NAMESPACE rollout status deployment/$DEPLOYMENT --timeout=120s || true

    # ------------------------------
    # 8ï¸âƒ£ Confirm service and print access URL
    # ------------------------------
    - name: ğŸ” Confirm service availability
      run: |
        NAMESPACE=fastapi
        echo "ğŸ“Š Current resources:"
        kubectl -n $NAMESPACE get all -o wide

        echo "ğŸŒ Checking NodePort URL..."
        NODE_PORT=$(kubectl -n $NAMESPACE get svc fastapi-svc -o jsonpath='{.spec.ports[0].nodePort}')
        NODE_IP=$(hostname -I | awk '{print $1}')
        echo "âœ… Your app should be available at:"
        echo "ğŸ‘‰ http://$NODE_IP:$NODE_PORT"
