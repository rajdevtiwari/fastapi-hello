name: CI-CD (self-hosted)

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: self-hosted
    environment: production

    steps:
    - name: ğŸ§¾ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: pytest -q

    # ğŸ‘‡ Add this step here
    - name: âš™ï¸ Verify kubeconfig (use real cluster)
      run: |
        export KUBECONFIG=/home/ceekh/.kube/config
        echo "âœ… Using kubeconfig from $KUBECONFIG"
        if [ ! -f "$KUBECONFIG" ]; then
          echo "âŒ kubeconfig not found!"
          exit 1
        fi
        kubectl config current-context
        kubectl get nodes

    - name: ğŸ³ Build Docker image locally
      run: |
        cd $GITHUB_WORKSPACE
        IMAGE_NAME="fastapi-hello"
        IMAGE_TAG=${{ github.sha }}
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
        echo "âœ… Image built: $IMAGE_NAME:$IMAGE_TAG"

    - name: ğŸ“¦ Load image into Minikube
      run: |
        IMAGE_NAME="fastapi-hello"
        IMAGE_TAG=${{ github.sha }}
        echo "ğŸ“¦ Loading image into Minikube..."
        minikube image load $IMAGE_NAME:$IMAGE_TAG

    - name: ğŸš€ Deploy to Kubernetes
      run: |
        cd $GITHUB_WORKSPACE
        echo "ğŸ“‚ Current directory:"
        pwd
        echo "ğŸ“„ Files:"
        ls -R k8s/

        NAMESPACE=fastapi
        DEPLOYMENT=fastapi-deployment
        CONTAINER=fastapi
        IMAGE="fastapi-hello:${{ github.sha }}"

        echo "ğŸš€ Ensuring namespace exists..."
        kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

        echo "ğŸ“¦ Applying manifests..."
        kubectl apply -f k8s/ -n $NAMESPACE

        echo "ğŸš€ Updating deployment with image: $IMAGE"
        kubectl -n $NAMESPACE set image deployment/$DEPLOYMENT $CONTAINER=$IMAGE --record || true
        kubectl -n $NAMESPACE rollout status deployment/$DEPLOYMENT --timeout=120s || true

    - name: ğŸ” Confirm service availability
      run: |
        kubectl -n fastapi get all -o wide
