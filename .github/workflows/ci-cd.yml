name: CI-CD (self-hosted)

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: self-hosted
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: pytest -q

    # Verify and prepare Kubernetes context
    - name: Verify kubeconfig and minikube
      run: |
        echo "KUBECONFIG=$HOME/.kube/config"
        if [ ! -f "$HOME/.kube/config" ]; then
          echo "‚ùå kubeconfig not found!"
          exit 1
        fi
        echo "‚úÖ kubeconfig found. Current context:"
        kubectl config current-context || true
        echo "Checking Minikube status..."
        minikube status || echo "‚ö†Ô∏è Minikube not running; trying to start..."
        minikube start --driver=docker || true
        kubectl get nodes

    - name: Build Docker image locally
      run: |
        IMAGE_NAME="fastapi-hello"
        IMAGE_TAG=${{ github.sha }}
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
        echo "‚úÖ Image built: $IMAGE_NAME:$IMAGE_TAG"

    - name: Load image into Minikube
      run: |
        IMAGE_NAME="fastapi-hello"
        IMAGE_TAG=${{ github.sha }}
        echo "üì¶ Loading image into Minikube..."
        minikube image load $IMAGE_NAME:$IMAGE_TAG

    - name: Deploy to Kubernetes
      run: |
        NAMESPACE=fastapi
        DEPLOYMENT=fastapi-deployment
        CONTAINER=fastapi
        IMAGE="fastapi-hello:${{ github.sha }}"

        echo "üöÄ Updating deployment with image: $IMAGE"
        kubectl -n $NAMESPACE set image deployment/$DEPLOYMENT $CONTAINER=$IMAGE --record
        kubectl -n $NAMESPACE rollout status deployment/$DEPLOYMENT --timeout=120s

    - name: Confirm service availability
      run: |
        kubectl -n fastapi get svc fastapi-svc -o wide
